name: CI

on:
  pull_request:
    branches: ["**"]
  push:
    branches: [main]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

# You can leverage Vercel Remote Caching with Turbo to speed up your builds
# @link https://turborepo.com/docs/core-concepts/remote-caching#remote-caching-on-vercel-builds
env:
  FORCE_COLOR: 3
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup
        uses: ./tooling/github/setup

      # - name: Copy env
      #   shell: bash
      #   run: cp .env.example .env

      - name: Lint
        run: pnpm lint && pnpm lint:ws

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup
        uses: ./tooling/github/setup

      - name: Format
        run: pnpm format

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup
        uses: ./tooling/github/setup

      - name: Typecheck
        run: pnpm typecheck

  test:
    runs-on: ubuntu-latest
    outputs:
      lines_pct: ${{ steps.coverage_metrics.outputs.lines_pct }}
      branches_pct: ${{ steps.coverage_metrics.outputs.branches_pct }}
      functions_pct: ${{ steps.coverage_metrics.outputs.functions_pct }}
      statements_pct: ${{ steps.coverage_metrics.outputs.statements_pct }}
      lines_diff: ${{ steps.compare_coverage.outputs.lines_diff }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup
        uses: ./tooling/github/setup

      - name: Test
        run: pnpm -F @acme/nextjs spec -- --run --coverage

      - name: Ensure coverage report exists
        run: |
          set -euo pipefail
          if [ ! -f apps/nextjs/coverage/coverage-final.json ]; then
            echo "coverage-final.json missing; writing 0% placeholder."
            mkdir -p apps/nextjs/coverage
            cat <<'JSON' > apps/nextjs/coverage/coverage-final.json
          {
            "__placeholder__": {
              "lines": { "covered": 0, "total": 1 },
              "branches": { "covered": 0, "total": 1 },
              "functions": { "covered": 0, "total": 1 },
              "statements": { "covered": 0, "total": 1 }
            }
          }
          JSON
          fi

      - name: Summarize coverage
        id: summarize_coverage
        run: |
          set -euo pipefail
          mkdir -p tmp
          node scripts/coverage-summary.mjs apps/nextjs/coverage/coverage-final.json tmp/nextjs-coverage-summary.json | tee tmp/nextjs-coverage-summary.txt

      - name: Capture coverage metrics
        id: coverage_metrics
        env:
          SUMMARY_PATH: tmp/nextjs-coverage-summary.json
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const summary = JSON.parse(fs.readFileSync(process.env.SUMMARY_PATH, "utf8"));
          const round = (value) => Math.round(value * 100) / 100;
          const append = (k, v) => fs.appendFileSync(process.env.GITHUB_OUTPUT, `${k}=${round(v)}\n`);
          append("lines_pct", summary.totals.lines.pct);
          append("branches_pct", summary.totals.branches.pct);
          append("functions_pct", summary.totals.functions.pct);
          append("statements_pct", summary.totals.statements.pct);
          NODE

      - name: Publish coverage summary
        run: |
          {
            echo "### Next.js coverage";
            cat tmp/nextjs-coverage-summary.txt;
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-coverage-${{ github.sha }}
          retention-days: 14
          path: |
            apps/nextjs/coverage
            tmp/nextjs-coverage-summary.json
            tmp/nextjs-coverage-summary.txt

      - name: Upload main coverage summary
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-coverage-summary
          retention-days: 21
          path: tmp/nextjs-coverage-summary.json

      - name: Download baseline coverage from main
        if: github.event_name == 'pull_request'
        id: main_coverage_artifact
        uses: actions/github-script@v7
        env:
          BASELINE_ARTIFACT_PATH: ${{ runner.temp }}/nextjs-coverage-main.zip
        with:
          script: |
            const fs = require("fs");
            const { owner, repo } = context.repo;
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: "ci.yml",
              branch: "main",
              status: "success",
              per_page: 5,
            });
            const run = runs.data.workflow_runs.find(Boolean);
            if (!run) {
              core.warning("Unable to find a successful main run with coverage artifact.");
              core.setOutput("found", "false");
              return;
            }
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: run.id,
              per_page: 50,
            });
            const artifact = artifacts.data.artifacts.find(
              (candidate) => candidate.name === "nextjs-coverage-summary",
            );
            if (!artifact) {
              core.warning(`No nextjs-coverage-summary artifact found on run ${run.id}.`);
              core.setOutput("found", "false");
              return;
            }
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifact.id,
              archive_format: "zip",
            });
            const buffer = Buffer.from(download.data);
            await fs.promises.writeFile(process.env.BASELINE_ARTIFACT_PATH, buffer);
            core.info(`Downloaded baseline coverage from run ${run.id}.`);
            core.setOutput("found", "true");
            core.setOutput("zip", process.env.BASELINE_ARTIFACT_PATH);

      - name: Extract baseline coverage summary
        if: steps.main_coverage_artifact.outputs.found == 'true'
        run: |
          set -euo pipefail
          rm -rf tmp/baseline-coverage
          mkdir -p tmp/baseline-coverage
          unzip -q "${{ steps.main_coverage_artifact.outputs.zip }}" -d tmp/baseline-coverage

      - name: Compare coverage against main
        if: steps.main_coverage_artifact.outputs.found == 'true'
        id: compare_coverage
        env:
          CURRENT_SUMMARY: tmp/nextjs-coverage-summary.json
        run: |
          set -euo pipefail
          BASELINE_SUMMARY=$(find tmp/baseline-coverage -name "nextjs-coverage-summary.json" -print -quit)
          if [ -z "$BASELINE_SUMMARY" ]; then
            echo "Unable to locate baseline coverage summary file." >&2
            exit 1
          fi
          export BASELINE_SUMMARY
          node - <<'NODE'
          const fs = require("fs");
          const current = JSON.parse(fs.readFileSync(process.env.CURRENT_SUMMARY, "utf8"));
          const baseline = JSON.parse(fs.readFileSync(process.env.BASELINE_SUMMARY, "utf8"));
          const round = (value) => Math.round(value * 100) / 100;
          const setOutput = (name, value) => fs.appendFileSync(process.env.GITHUB_OUTPUT, `${name}=${value}\n`);
          const metrics = ["lines", "branches", "functions", "statements"];
          const lines = metrics.map((metric) => {
            const currentPct = round(current.totals[metric].pct);
            const baselinePct = round(baseline.totals[metric].pct);
            const diff = round(currentPct - baselinePct);
            setOutput(`baseline_${metric}_pct`, baselinePct);
            setOutput(`${metric}_diff`, diff);
            return `- ${metric[0].toUpperCase() + metric.slice(1)}: ${currentPct}% (Î” ${diff} vs ${baselinePct}%)`;
          });
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `\n### Coverage delta vs main\n${lines.join("\n")}\n`);
          NODE
